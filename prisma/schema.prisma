// ============================================
// BARBERSHOP BOOKING SYSTEM DATABASE SCHEMA
// Clean Architecture with Prisma ORM
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

// Users jadvali - Foydalanuvchilar (User, Barber, Admin)
model User {
  id        String   @id @default(uuid())
  email     String   @unique // Email manzil
  phone     String   @unique // Telefon raqam
  password  String // Parol (hash qilingan)
  firstName String   @map("first_name") // Ism
  lastName  String   @map("last_name") // Familiya
  avatar    String? // Avatar rasmi
  role      UserRole @default(USER) // Role: USER, BARBER, ADMIN

  // Relations
  barber       Barber?
  bookings     Booking[]
  favorites    Favorite[]
  reviews      Review[]
  notifications Notification[]
  clientNotes   ClientNote[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

enum UserRole {
  USER
  BARBER
  ADMIN
}

// ============================================
// BARBER MANAGEMENT
// ============================================

model Barber {
  id           String  @id @default(uuid())
  userId       String  @unique @map("user_id")
  bio          String?
  specialty    String?
  experience   Int     @default(0)
  rating       Float   @default(0)
  totalReviews Int     @default(0) @map("total_reviews")
  location     String?
  latitude     Float?
  longitude    Float?

  // Images
  image     String?
  portfolio Json?   @default("[]") // JSON array of portfolio items: [{id, image, title, description?, category?}]

  // Availability
  isAvailable Boolean @default(true) @map("is_available")

  // Working Hours
  workingDays String[] @default([]) @map("working_days") // ["monday", "tuesday", ...]

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  services    Service[]
  bookings    Booking[]
  reviews     Review[]
  favorites   Favorite[]
  schedule    Schedule[]
  clientNotes ClientNote[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("barbers")
}

// ============================================
// SERVICES
// ============================================

// Services jadvali - Barber xizmatlari
model Service {
  id          String  @id @default(uuid())
  barberId    String  @map("barber_id") // Barber ID
  name        String // Xizmat nomi
  description String? // Tavsifi
  duration    Int     @default(30) // Davomiylik (minut)
  price       Float // Narx (so'm)

  barber   Barber    @relation(fields: [barberId], references: [id], onDelete: Cascade)
  bookings Booking[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("services")
}

// ============================================
// SCHEDULE MANAGEMENT
// ============================================

// Schedule jadvali - Ish jadvali (har bir barber uchun kunlik)
model Schedule {
  id         String  @id @default(uuid())
  barberId   String  @map("barber_id") // Barber ID
  day        String // Kun: "monday", "tuesday", etc.
  startTime  String  @map("start_time") // Boshlanish vaqti: "09:00"
  endTime    String  @map("end_time") // Tugash vaqti: "18:00"
  lunchStart String? @map("lunch_start") // Tushlik boshlanish: "13:00"
  lunchEnd   String? @map("lunch_end") // Tushlik tugash: "14:00"
  isWorking  Boolean @default(true) @map("is_working") // Bu kunda ishlamasami

  barber Barber @relation(fields: [barberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([barberId, day])
  @@map("schedules")
}

// ============================================
// BOOKINGS
// ============================================

// Booking jadvali - Bandliklar
model Booking {
  id        String @id @default(uuid())
  userId    String @map("user_id") // User ID
  barberId  String @map("barber_id") // Barber ID
  serviceId String @map("service_id") // Service ID

  date      DateTime // Sana va vaqt
  startTime String   @map("start_time") // Boshlanish vaqti: "14:00"
  endTime   String   @map("end_time") // Tugash vaqti

  status     BookingStatus @default(PENDING) // Holati: PENDING, CONFIRMED, COMPLETED...
  paymentType PaymentType? @map("payment_type") // To'lov turi: CASH, CARD
  notes       String? // Izohlar
  clientNotes String? @map("client_notes") // Barber uchun mijoz haqida eslatmalar

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  barber       Barber        @relation(fields: [barberId], references: [id], onDelete: Cascade)
  service      Service       @relation(fields: [serviceId], references: [id])
  review       Review?
  notifications Notification[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([barberId])
  @@index([date])
  @@map("bookings")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentType {
  CASH // Naqt to'lov
  CARD // Plastik karta
}

// ============================================
// FAVORITES
// ============================================

// Favorite jadvali - Sevimli barberlar
model Favorite {
  id       String @id @default(uuid())
  userId   String @map("user_id") // User ID
  barberId String @map("barber_id") // Barber ID

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  barber Barber @relation(fields: [barberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, barberId])
  @@map("favorites")
}

// ============================================
// REVIEWS & RATINGS
// ============================================

// Review jadvali - Sharh va reytinglar
model Review {
  id        String  @id @default(uuid())
  userId    String  @map("user_id") // User ID
  barberId  String  @map("barber_id") // Barber ID
  bookingId String? @unique @map("booking_id") // Booking ID (ixtiyoriy)

  rating  Int // Reyting: 1-5
  comment String? // Sharh matni

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  barber  Barber   @relation(fields: [barberId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([barberId])
  @@index([userId])
  @@map("reviews")
}

// ============================================
// SPECIAL OFFERS
// ============================================

// Offer jadvali - Maxsus takliflar
model Offer {
  id          String   @id @default(uuid())
  barberId    String?  @map("barber_id") // Barber ID (ixtiyoriy)
  title       String // Taklif nomi
  description String? // Tavsifi
  discount    Float    @default(0) // Chegirma foiz
  startDate   DateTime @map("start_date") // Boshlanish sanasi
  endDate     DateTime @map("end_date") // Tugash sanasi
  isActive    Boolean  @default(true) @map("is_active") // Faolmi

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("offers")
}

// ============================================
// NOTIFICATIONS
// ============================================

// Notification jadvali - Xabarnomalar
model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id") // User ID (USER yoki BARBER)
  type      NotificationType // Notification turi
  title     String // Sarlavha
  message   String // Xabar matni
  read      Boolean          @default(false) // O'qilganmi
  bookingId String?          @map("booking_id") // Booking ID (ixtiyoriy)
  metadata  Json? // Qo'shimcha ma'lumotlar (JSON)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  BOOKING_CREATED // Booking yaratildi
  BOOKING_CONFIRMED // Booking tasdiqlandi
  BOOKING_CANCELLED // Booking bekor qilindi
  BOOKING_REMINDER // Booking eslatmasi (1 kun oldin, 1 soat oldin)
  BOOKING_STATUS_CHANGED // Booking status o'zgardi
  REVIEW_RECEIVED // Sharh qoldirildi
  NEW_MESSAGE // Yangi xabar (keyingi versiyada)
}

// ============================================
// CLIENT NOTES
// ============================================

// ClientNote jadvali - Barber'ning mijozlar haqidagi eslatmalari
model ClientNote {
  id        String   @id @default(uuid())
  barberId  String   @map("barber_id") // Barber ID
  userId    String   @map("user_id") // User ID (mijoz)
  note      String // Eslatma matni
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  barber Barber @relation(fields: [barberId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([barberId, userId])
  @@index([barberId])
  @@index([userId])
  @@map("client_notes")
}
